DROP TABLE IF EXISTS PUBLIC.temp_07_maestra_productos;
CREATE TABLE PUBLIC.temp_07_maestra_productos AS 

WITH 
maproducto_periodo_act AS ( 
	SELECT  
			 "COD_PRODUCTO",
			 "COD_OFERTA_PROMOCION",
			 "COD_NEGOCIO",
			 "COD_VARIEDAD",
			 "COD_TIPO_SABOR" AS "COD_TIPODESABOR",
			 "COD_TIPO_SALCHICHA",
			 "COD_TIPO_CARNE",
			 "COD_TIPO",
			 "COD_TAMANO_nls",
			 "COD_SUBTIPO",
			 "COD_SUBSEGMENTO_NOEL",
			 "COD_SUBMARCA",
			 "COD_SUBLINEA",
			 "COD_SUBCATEGORY",
			 "COD_SEGMENTO_TMLUC",
			 "COD_SEGMENTO_NOEL",
			 "COD_SEGMENTO",
			 "COD_SEGM_PRECIO",
			 "COD_SABOR",
			 "COD_PRESENTACION",
			 "COD_MARCA",
			 "COD_LINEA",
			 "COD_INTEGRALNOINTEGRAL",
			 "COD_FORMA",
			 "COD_FAMILIA_DE_EMPAQUE",
			 "COD_FAMILIA",
			 "COD_FABRICANTE",
			 "COD_EMPAQUE",
			 "COD_CONSISTENCIA",
			 "COD_CATEGORY",
			 "ITEM",
			 '' AS "BARCODE", 
			 "UNIDAD",
			 -- "FACTOR", -- estas son las unidades por empaque del item volumen
			 "COD_TIPONEG",
			 '' AS "ATTRGEN2",
			 '' AS "ATTRGEN3",
			 -- "ATTRGEN4",
			 -- "ATTRGEN5",
			 -- "ATTRGEN6",
			 -- "ATTRGEN7",
			 '' AS "ATTRGEN9",
			 '' AS "ATTRGEN10",
			 "AÑO",
			 "COD_NIVELDEAZUCAR",
			 "ATTRGEN8" AS "COD_MUNDOS_SHOPPER",			 
			 MAX("peso") AS "PESO" -- este debe ser el peso del item volumen
	FROM PUBLIC.temp_05_va_codificacion7
	GROUP BY "COD_PRODUCTO",
			 	"COD_OFERTA_PROMOCION",
			 	"COD_NEGOCIO",
			 	"COD_VARIEDAD",
			 	"COD_TIPO_SABOR",
			 	"COD_TIPO_SALCHICHA",
			 	"COD_TIPO_CARNE",
			 	"COD_TIPO",
			    "COD_TAMANO_nls",  
			 	"COD_SUBTIPO",
			 	"COD_SUBSEGMENTO_NOEL",
			 	"COD_SUBMARCA",
			 	"COD_SUBLINEA",
			 	"COD_SUBCATEGORY",
			 	"COD_SEGMENTO_TMLUC",
			 	"COD_SEGMENTO_NOEL",
			 	"COD_SEGMENTO",
			 	"COD_SEGM_PRECIO",
			 	"COD_SABOR",
			 	"COD_PRESENTACION",
			 	"COD_MARCA",
			 	"COD_LINEA",
			 	"COD_INTEGRALNOINTEGRAL",
			 	"COD_FORMA",
			 	"COD_FAMILIA_DE_EMPAQUE",
			 	"COD_FAMILIA",
			 	"COD_FABRICANTE",
			 	"COD_EMPAQUE",
			 	"COD_CONSISTENCIA",
			 	"COD_CATEGORY",
			 	"ITEM",
			 	"BARCODE", 
			 	"UNIDAD",
			  	-- "FACTOR", 
			 	"COD_TIPONEG",		 
			 	-- "ATTRGEN4",
			 	-- "ATTRGEN5",
			 	-- "ATTRGEN6",
			 	-- "ATTRGEN7",		 
			 	"AÑO",
				"COD_NIVELDEAZUCAR",
				"ATTRGEN8"
),			

ma_producto_periodo_act_row_number AS ( -- pendiente ordenar tambien por mes
	SELECT *,row_number() OVER (partition BY "COD_PRODUCTO" ORDER BY "COD_PRODUCTO","COD_TIPO_CARNE" ASC) AS rownum 
	FROM maproducto_periodo_act
),

ma_producto_perido_ant AS (
	SELECT "COD_PRODUCTO"::TEXT,			 
			"COD_NEGOCIO"::TEXT,
			"COD_CATEGORY"::TEXT,
			"COD_SEGMENTO"::TEXT,
			"COD_FABRICANTE"::TEXT,
			"COD_MARCA"::TEXT,
			"COD_SUBMARCA"::TEXT,
			"COD_TIPO"::TEXT,
			"COD_SUBTIPO"::TEXT,
			"COD_TAMANO_nls"::TEXT,
			"COD_VARIEDAD"::TEXT,
			"COD_SABOR"::TEXT,
			"COD_TIPODESABOR"::TEXT,
			"COD_EMPAQUE"::TEXT,
			"COD_PRESENTACION"::TEXT,
			"COD_INTEGRALNOINTEGRAL"::TEXT,
			"COD_CONSISTENCIA"::TEXT,
			"COD_NIVELDEAZUCAR"::TEXT,
			"ITEM"::TEXT,
			"COD_OFERTA_PROMOCION"::TEXT, 
			"COD_TIPO_SALCHICHA"::TEXT,
			"COD_TIPO_CARNE"::TEXT,
			"COD_FAMILIA_DE_EMPAQUE"::TEXT,
			"COD_SEGMENTO_NOEL"::TEXT,			 			 
			"COD_SUBSEGMENTO_NOEL"::TEXT,
			"COD_LINEA"::TEXT,			 			 
			"COD_SUBLINEA"::TEXT,
			"COD_TIPONEG"::TEXT,
			"COD_FORMA"::TEXT,
			"COD_SEGM_PRECIO"::TEXT,
			"BARCODE"::TEXT,
			"COD_FAMILIA"::TEXT,			 
			"COD_SUBCATEGORY"::TEXT,
			"COD_SEGMENTO_TMLUC"::TEXT,	
			"PESO"::NUMERIC, 
			"UNIDAD"::TEXT,
			--"FACTOR"::NUMERIC,
			"ATTRGEN2"::TEXT,
			"ATTRGEN3"::TEXT,
			-- "ATTRGEN4",
			-- "ATTRGEN5",
			-- "ATTRGEN6",
			-- "ATTRGEN7",
			"COD_MUNDOS_SHOPPER"::TEXT,
			"ATTRGEN9"::TEXT,
			"ATTRGEN10"::TEXT,
			0 AS "PERIODO_ACT"
	FROM scantrack.sa_maproducto
),

ma_producto_periodo_act AS (
	SELECT 
			"COD_PRODUCTO",			 
			"COD_NEGOCIO",
			"COD_CATEGORY",
			"COD_SEGMENTO",
			"COD_FABRICANTE",
			"COD_MARCA",
			"COD_SUBMARCA",
			"COD_TIPO",
			"COD_SUBTIPO",
			"COD_TAMANO_nls",
			"COD_VARIEDAD",
			"COD_SABOR",
			"COD_TIPODESABOR",
			"COD_EMPAQUE",
			"COD_PRESENTACION",
			"COD_INTEGRALNOINTEGRAL",
			"COD_CONSISTENCIA",
			"COD_NIVELDEAZUCAR",
			"ITEM",
			"COD_OFERTA_PROMOCION", 
			"COD_TIPO_SALCHICHA",
			"COD_TIPO_CARNE",
			"COD_FAMILIA_DE_EMPAQUE",
			"COD_SEGMENTO_NOEL",			 			 
			"COD_SUBSEGMENTO_NOEL",
			"COD_LINEA",			 			 
			"COD_SUBLINEA",
			"COD_TIPONEG",
			"COD_FORMA",
			"COD_SEGM_PRECIO",
			"BARCODE",
			"COD_FAMILIA",			 
			"COD_SUBCATEGORY",
			"COD_SEGMENTO_TMLUC",	
			"PESO"::NUMERIC, 
			"UNIDAD",
			-- "FACTOR",
			"ATTRGEN2",
			"ATTRGEN3",
			-- "ATTRGEN4",
			-- "ATTRGEN5",
			-- "ATTRGEN6",
			-- "ATTRGEN7",
			"COD_MUNDOS_SHOPPER",
			"ATTRGEN9",
			"ATTRGEN10",
			1 AS "PERIODO_ACT"
	FROM ma_producto_periodo_act_row_number
	WHERE rownum = 1
	-- AND "COD_PRODUCTO" = 'P0502N40005045'
),

ma_producto_union AS (			
	SELECT *
	FROM ma_producto_perido_ant
	UNION ALL 
	SELECT *
	FROM ma_producto_periodo_act
),

ma_producto_union_row_number AS (
	SELECT *,row_number() OVER (partition BY "COD_PRODUCTO" ORDER BY "COD_PRODUCTO","PERIODO_ACT" DESC) AS rownum 
	FROM ma_producto_union
)

SELECT *
FROM ma_producto_union_row_number
WHERE rownum = 1;

-- actualizar tabla sa_producto

DROP TABLE IF EXISTS PUBLIC.temp_07_maestra_productos_;
CREATE TABLE PUBLIC.temp_07_maestra_productos_ AS 
SELECT "COD_PRODUCTO"::TEXT,			 
		"COD_NEGOCIO"::TEXT,
		"COD_CATEGORY"::TEXT,
		"COD_SEGMENTO"::TEXT,
		"COD_FABRICANTE"::TEXT,
		"COD_MARCA"::TEXT,
		"COD_SUBMARCA"::TEXT,
		"COD_TIPO"::TEXT,
		"COD_SUBTIPO"::TEXT,
		"COD_TAMANO_nls"::TEXT,
		"COD_VARIEDAD"::TEXT,
		"COD_SABOR"::TEXT,
		"COD_TIPODESABOR"::TEXT,
		"COD_EMPAQUE"::TEXT,
		"COD_PRESENTACION"::TEXT,
		"COD_INTEGRALNOINTEGRAL"::TEXT,
		"COD_CONSISTENCIA"::TEXT,
		"COD_NIVELDEAZUCAR"::TEXT,
		"ITEM"::TEXT,
		"COD_OFERTA_PROMOCION"::TEXT, 
		"COD_TIPO_SALCHICHA"::TEXT,
		"COD_TIPO_CARNE"::TEXT,
		"COD_FAMILIA_DE_EMPAQUE"::TEXT,
		"COD_SEGMENTO_NOEL"::TEXT,			 			 
		"COD_SUBSEGMENTO_NOEL"::TEXT,
		"COD_LINEA"::TEXT,			 			 
		"COD_SUBLINEA"::TEXT,
		"COD_TIPONEG"::TEXT,
		"COD_FORMA"::TEXT,
		"COD_SEGM_PRECIO"::TEXT,
		"BARCODE"::TEXT,
		"COD_FAMILIA"::TEXT,			 
		"COD_SUBCATEGORY"::TEXT,
		"COD_SEGMENTO_TMLUC"::TEXT,	
		"PESO"::NUMERIC, 
		"UNIDAD"::TEXT,
		-- "FACTOR"::NUMERIC,
		"ATTRGEN2"::TEXT,
		"ATTRGEN3"::TEXT,
		-- "ATTRGEN4"::TEXT,
		-- "ATTRGEN5"::TEXT,
		-- "ATTRGEN6"::TEXT,
		-- "ATTRGEN7"::TEXT,
		"COD_MUNDOS_SHOPPER"::TEXT,
		"ATTRGEN9"::TEXT,
		"ATTRGEN10"::TEXT
FROM public.temp_07_maestra_productos
UNION ALL 
SELECT "COD_PRODUCTO"::TEXT,			 
		"COD_NEGOCIO"::TEXT,
		"COD_CATEGORY"::TEXT,
		"COD_SEGMENTO"::TEXT,
		"COD_FABRICANTE"::TEXT,
		"COD_MARCA"::TEXT,
		"COD_SUBMARCA"::TEXT,
		"COD_TIPO"::TEXT,
		"COD_SUBTIPO"::TEXT,
		"COD_TAMANO_nls"::TEXT,
		"COD_VARIEDAD"::TEXT,
		"COD_SABOR"::TEXT,
		"COD_TIPODESABOR"::TEXT,
		"COD_EMPAQUE"::TEXT,
		"COD_PRESENTACION"::TEXT,
		"COD_INTEGRALNOINTEGRAL"::TEXT,
		"COD_CONSISTENCIA"::TEXT,
		"COD_NIVELDEAZUCAR"::TEXT,
		"ITEM"::TEXT,
		"COD_OFERTA_PROMOCION"::TEXT, 
		"COD_TIPO_SALCHICHA"::TEXT,
		"COD_TIPO_CARNE"::TEXT,
		"COD_FAMILIA_DE_EMPAQUE"::TEXT,
		"COD_SEGMENTO_NOEL"::TEXT,			 			 
		"COD_SUBSEGMENTO_NOEL"::TEXT,
		"COD_LINEA"::TEXT,			 			 
		"COD_SUBLINEA"::TEXT,
		"COD_TIPONEG"::TEXT,
		"COD_FORMA"::TEXT,
		"COD_SEGM_PRECIO"::TEXT,
		"BARCODE"::TEXT,
		"COD_FAMILIA"::TEXT,			 
		"COD_SUBCATEGORY"::TEXT,
		"COD_SEGMENTO_TMLUC"::TEXT,	
		"PESO"::NUMERIC, 
		"UNIDAD"::TEXT,
		-- "FACTOR"::NUMERIC,
		"ATTRGEN2"::TEXT,
		"ATTRGEN3"::TEXT,
		-- "ATTRGEN4"::TEXT,
		-- "ATTRGEN5"::TEXT,
		-- "ATTRGEN6"::TEXT,
		-- "ATTRGEN7"::TEXT,
		"COD_MUNDOS_SHOPPER"::TEXT,
		"ATTRGEN9"::TEXT,
		"ATTRGEN10"::TEXT
FROM scantrack.sa_maproducto;

DROP TABLE IF EXISTS scantrack.sa_maproducto;
CREATE TABLE scantrack.sa_maproducto AS 
SELECT *
FROM PUBLIC.temp_07_maestra_productos_;

DROP TABLE IF EXISTS PUBLIC.temp_07_maestra_productos_;
